# OCR API 仕様書 v1.0

## 1. 概要

本 API は、PDF 由来のデジタル文書キャプチャ画像を対象とした OCR 処理を行い、
抽出されたテキストおよび行単位情報（bbox 含む）を JSON 形式で返却する。

本仕様は v1.0 とし、縦書き対応および文字正規化は対象外とする。

使用モデル: [ndlocr-lite](https://github.com/ndl-lab/ndlocr-lite) の ONNX モデル

---

## 2. 対応範囲

### 2.1 対象入力

- PDF 由来のデジタル文書キャプチャ画像
- 横書き文書のみ

### 2.2 非対応

- 手書き文字
- 写真撮影画像
- 縦書き文書（Phase 2 で対応予定）

---

## 3. 入力仕様

### 3.1 画像制約

| 項目 | 制約 |
|------|------|
| 最大解像度 | 3000 × 3000 px |
| 最大ファイルサイズ | 10 MB |
| 対応フォーマット | PNG / JPEG |

制約を超える場合はエラーを返却する。

---

### 3.2 リクエスト形式

**エンドポイント:** `POST /v1/ocr`  
**Content-Type:** `multipart/form-data`  
**認証:** なし（個人利用のため不要）

| パラメータ | 型 | 必須 | 説明 |
|---|---|---|---|
| `file` | 画像ファイル | 必須 | OCR 対象画像 |
| `minLineHeightPx` | integer | 任意 | 行として扱う最小高さ（px）。未指定時のデフォルト: `8` |

---

## 4. 処理フロー

```
入力画像
  ↓
サイズ・容量検証
  ↓
グレースケール変換
  ↓
二値化（Otsu + BinaryInv）
  ↓
Y 方向 Projection による行分割
  └─ 行高さ < minLineHeightPx は除外
  ↓
各行を OCR（ndlocr-lite ONNX）
  ↓
CTC Greedy Decode
  ↓
結果統合
```

---

## 5. 行分割仕様

### 5.1 分割方式

- Y 方向 Projection Profile を使用
- 空白領域で行を分離する

### 5.2 行高さ制約

- 行高さが `minLineHeightPx` 未満の場合は除外
- デフォルト値: `8` px

### 5.3 空行

- 空行は出力に含めない

---

## 6. 出力仕様

### 6.1 正常レスポンス

**HTTP 200**  
**Content-Type:** `application/json`

```json
{
  "text": "全文テキスト",
  "lines": [
    {
      "text": "行テキスト",
      "bbox": {
        "x": 0,
        "y": 0,
        "w": 0,
        "h": 0
      }
    }
  ]
}
```

### 6.2 フィールド定義

| フィールド | 型 | 説明 |
|---|---|---|
| `text` | string | 全行テキストを `\n` で連結した文字列 |
| `lines` | array | 行単位の結果 |
| `lines[].text` | string | 行テキスト |
| `lines[].bbox` | object | 元画像座標系での矩形情報 |
| `bbox.x` | integer | 左上 X 座標 |
| `bbox.y` | integer | 左上 Y 座標 |
| `bbox.w` | integer | 幅 |
| `bbox.h` | integer | 高さ |

### 6.3 bbox 仕様

- 元画像座標系で返却する
- 単位は pixel

---

## 7. 文字処理仕様

- 文字正規化は行わない
- Unicode 変換、全角半角変換は実施しない
- CTC Greedy Decode のパラメータ（blank トークン・繰り返し文字処理）は ndlocr-lite の実装仕様に準拠する

---

## 8. 並列処理

- シングルスレッド・逐次処理とする（個人利用のため並列対応は不要）
- リクエストキューは設けない

---

## 9. エラー仕様

以下の場合はエラーを返却する。

| 条件 | HTTP | エラーメッセージ例 | 説明 |
|---|---|---|---|
| サイズ制限違反 | 400 | `"image_too_large"` | 画像解像度またはファイルサイズが制限を超過 |
| 白紙画像 | 400 | `"blank_image"` | 黒画素率が 0.1% 未満（白紙とみなす） |
| 行未検出 | 400 | `"no_lines_detected"` | 行分割の結果、有効な行が 0 件 |
| 推論処理失敗 | 500 | `"inference_error"` | ONNX 推論中のエラー |

### 9.1 エラーレスポンス

**Content-Type:** `application/json`

```json
{
  "error": "no_lines_detected"
}
```

HTTP ステータスはエラー条件テーブルの `HTTP` 列に従う（上記参照）。

---

## 10. 性能目標

| 項目 | 目標値 |
|---|---|
| 応答時間 | 1 秒以内（超過は許容） |

---

## 11. モデル管理

- `ndlocr-lite.onnx` と `charset.txt` は常にセットで管理する
- バージョン不一致での運用は禁止する

---

## 12. バージョン管理

| バージョン | 内容 |
|---|---|
| v1.0 | 初版。横書き OCR、bbox 出力対応 |
| Phase 2（予定） | 縦書き対応・文字正規化など拡張機能 |
